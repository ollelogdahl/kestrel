
import re
import os

def get_version_from_header(header_path, macro_name):
    """Parses a C header for a #define macro_name value."""
    # Use the absolute path from CMake
    full_path = os.path.join("@CMAKE_SOURCE_DIR@", header_path)
    try:
        with open(full_path, "r") as f:
            content = f.read()
            # Look for #define MACRO_NAME "version" or #define MACRO_NAME 1.2.3
            match = re.search(rf'#define\s+{macro_name}\s+"?([\d\.]+)"?', content)
            if match:
                return match.group(1)
    except Exception:
        return "Unknown"
    return "Unknown"

project = '@PROJECT_NAME@'
copyright = '@PROJECT_COPYRIGHT@, @PROJECT_AUTHORS@'
author = '@PROJECT_AUTHORS@'

# The short X.Y version
version = '@PROJECT_VERSION_MAJOR@.@PROJECT_VERSION_MINOR@'
# The full version, including alpha/beta/rc tags
release = '@PROJECT_VERSION@'

extensions = [
    'sphinx.ext.autodoc',
    'sphinx.ext.intersphinx',
    'sphinx.ext.todo',
    'sphinx.ext.viewcode',
    'breathe',
]

# Linux Kernel trick: Enforce heading levels
# (Manual enforcement in your docs, but you can add logic here)

templates_path = ['_templates']
exclude_patterns = ['Thumbs.db', '.DS_Store', 'conf.py.in', '.venv', 'CMakeLists.txt']
html_theme = 'sphinx_rtd_theme'

html_static_path = ['@CMAKE_CURRENT_SOURCE_DIR@/_static']
html_sidebars = {
    "**": [
        "about.html",
        "searchfield.html",
        "navigation.html",
        "relations.html",
        "donate.html",
    ]
}
html_context = {
    "display_github": True,
    "github_user": "ollelogdahl",
    "github_repo": "kestrel",
    "github_version": "master",
    "conf_py_path": "/docs/"
}

breathe_projects = { "@PROJECT_NAME@": "@CMAKE_CURRENT_BINARY_DIR@/xml" }
breathe_default_project = "@PROJECT_NAME@"

nitpick_ignore = [
    ('cpp:identifier', 'uint64_t'),
    ('cpp:identifier', 'uint32_t'),
    ('cpp:identifier', 'uint16_t'),
    ('cpp:identifier', 'uint8_t'),
    ('cpp:identifier', 'size_t'),
]

def setup(app):
    app.add_css_file('custom.css')
